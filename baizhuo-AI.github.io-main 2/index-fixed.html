<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æ¨¡å‹ä»·æ ¼çœ‹æ¿ - H5</title>
  <meta name="description" content="AI æ¨¡å‹ä»·æ ¼çœ‹æ¿ï¼ˆä¸Šä¼ Excelï¼Œæ”¯æŒæ”¶è—/å¸¸ç”¨/å•ä½å¸ç§åˆ‡æ¢/å‚å•†ç­›é€‰/ä¸­è‹±åˆ‡æ¢/è¯„è®º/å¯¼å‡ºCSVï¼‰" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .two-lines { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    #boot-msg { color:#64748b; font-size:14px; text-align:center; padding:24px; }
    #err { white-space: pre-wrap; color:#b91c1c; background:#fff7ed; border:1px solid #fecaca; border-radius:12px; padding:12px; margin:12px auto; max-width: 960px; display:none; }
  </style>
</head>
<body class="bg-gray-50">
  <div id="root">
    <div id="boot-msg">æ­£åœ¨åŠ è½½èµ„æºâ€¦â€¦å¦‚é•¿æ—¶é—´æ— å“åº”ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæ˜¯å¦èƒ½è®¿é—® <code>unpkg.com</code> ä¸ <code>cdn.tailwindcss.com</code>ã€‚</div>
    <div id="err"></div>
  </div>

  <!-- React UMDï¼ˆç”Ÿäº§ç‰ˆï¼‰ -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <!-- Babel Standaloneï¼ˆå¼€å¯ JSX é¢„è®¾ï¼‰ -->
  <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
  <!-- XLSX è§£æ -->
  <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>

  <script>
    // åŸºç¡€é”™è¯¯å±•ç¤ºï¼ˆé¿å…ç©ºç™½é¡µï¼‰
    window.addEventListener('error', function (e) {
      var box = document.getElementById('err');
      if (box) {
        box.style.display = 'block';
        box.textContent = (e.error && e.error.stack) ? e.error.stack : (e.message || e.toString());
      }
    });
  </script>

  <!-- ä¸šåŠ¡ä»£ç ï¼ˆä½¿ç”¨ JSXï¼Œå¿…é¡»æŒ‡å®š data-presets="react"ï¼‰ -->
  <script type="text/babel" data-presets="react">
    const { useEffect, useMemo, useRef, useState } = React;

    const I18N = {
      zh: { title:"æ¨¡å‹ä»·æ ¼çœ‹æ¿", upload:"ä¸Šä¼ Excelï¼ˆ.xlsx/.xlsï¼‰", or:"æˆ–", loadDemo:"è½½å…¥ç¤ºä¾‹æ•°æ®",
        view:"è§†å›¾", view_all:"å…¨éƒ¨", view_fav:"æ”¶è—", view_common:"å¸¸ç”¨",
        unit:"å•ä½", per1k:"æ¯åƒ tokens", per1m:"æ¯ç™¾ä¸‡ tokens",
        srcCurrency:"æ•°æ®æºå¸ç§", displayCurrency:"æ˜¾ç¤ºå¸ç§", fxRate:"æ±‡ç‡(1 USD â†’ CNY)",
        provider:"å‚å•†ç­›é€‰", language:"ç•Œé¢è¯­è¨€", search:"æœç´¢æ¨¡å‹/è¯´æ˜",
        table_provider:"å‚å•†", table_name:"æ¨¡å‹åç§°", table_rule:"è®¡è´¹è§„åˆ™",
        table_miaodong_in:"ç§’æ‡‚è¾“å…¥", table_miaodong_out:"ç§’æ‡‚è¾“å‡º",
        table_official_in:"å®˜æ–¹è¾“å…¥", table_official_out:"å®˜æ–¹è¾“å‡º",
        table_ops:"æ“ä½œ", fav:"æ”¶è—", unfav:"å–æ¶ˆæ”¶è—", comment:"è¯„è®º",
        noData:"è¯·å…ˆä¸Šä¼  Excel æˆ–åŠ è½½ç¤ºä¾‹æ•°æ®", avgRating:"å¹³å‡è¯„åˆ†",
        addComment:"æ–°å¢è¯„è®º", nickname:"æ˜µç§°(å¯é€‰)", rating:"è¯„åˆ†(1-5)",
        content:"è¯„è®ºå†…å®¹", submit:"æäº¤", cancel:"å–æ¶ˆ", exportCsv:"å¯¼å‡ºå½“å‰è§†å›¾ä¸º CSV",
        priceNote:"æ³¨ï¼šè‹¥è§„åˆ™éæŒ‰ tokens è®¡è´¹ï¼Œå°†ä»¥åŸè¡¨å•ä»·å±•ç¤ºã€‚", none:"â€”", close:"å…³é—­" },
      en: { title:"Model Pricing Dashboard", upload:"Upload Excel (.xlsx/.xls)", or:"or", loadDemo:"Load Demo",
        view:"View", view_all:"All", view_fav:"Favorites", view_common:"Common",
        unit:"Unit", per1k:"Per 1K tokens", per1m:"Per 1M tokens",
        srcCurrency:"Source Currency", displayCurrency:"Display Currency", fxRate:"FX (1 USD â†’ CNY)",
        provider:"Provider Filter", language:"Language", search:"Search name/notes",
        table_provider:"Provider", table_name:"Model Name", table_rule:"Billing Rule",
        table_miaodong_in:"Miaodong In", table_miaodong_out:"Miaodong Out",
        table_official_in:"Official In", table_official_out:"Official Out",
        table_ops:"Actions", fav:"Star", unfav:"Unstar", comment:"Comments",
        noData:"Please upload Excel or load demo data.", avgRating:"Avg Rating",
        addComment:"Add Comment", nickname:"Nickname (optional)", rating:"Rating (1-5)",
        content:"Comment", submit:"Submit", cancel:"Cancel", exportCsv:"Export CSV (current view)",
        priceNote:"Note: If non-token billing, raw price is shown.", none:"â€”", close:"Close" }
    };
    const LS_FAV_KEY="model-favorites-v1", LS_COMMENTS_KEY="model-comments-v1";
    const isTruthy=v=>v===true?true:(typeof v==="number"?v!==0:(typeof v==="string"?["æ˜¯","yes","y","true","1"].includes(v.trim().toLowerCase()):false));
    const parseNumber=v=>v==null?null:(typeof v==="number"? (isFinite(v)?v:null) : (typeof v==="string"? (n=>isFinite(n)?n:null)(parseFloat(v.replace(/[,\s]/g,"").replace(/[ï¿¥Â¥$]/g,"").replace(/cny|rmb|usd/gi,""))) : null));
    const isTokenBasedRule=rule=>{ if(!rule) return true; const s=String(rule).toLowerCase(); return /token|1k|åƒ|ç™¾ä¸‡|1m/.test(s); };
    const convertUnit=(v,to)=> v==null?null:(to==="per1k"?v:v*1000);
    const convertCurrency=(v,src,display,fx)=>{ if(v==null)return null; if(src===display)return v; if(src==="USD"&&display==="CNY")return v*fx; if(src==="CNY"&&display==="USD")return v/fx; return v; };
    const formatMoney=(n,cur)=> n==null||isNaN(Number(n))? "-" : (cur==="CNY"?"Â¥":"$") + Number(n).toLocaleString(undefined,{maximumFractionDigits:6});
    const modelKey=r=>`${r.å‚å•† ?? ""}__${r.æ¨¡å‹åç§° ?? ""}`;
    const exportCsv=(rows,headers)=>{ const csv=[headers.join(",")].concat(rows.map(r=>headers.map(h=>{const v=r[h]; const s=(v==null)? "": String(v); return /[",\n]/.test(s)? '"'+s.replace(/"/g,'""')+'"' : s; }).join(","))).join("\n");
      const blob=new Blob([csv],{type:"text/csv;charset=utf-8;"}); const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download=`model_pricing_${Date.now()}.csv`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); };

    const loadAllComments=()=>{ try{return JSON.parse(localStorage.getItem(LS_COMMENTS_KEY)||"{}");}catch{return{};} };
    const saveAllComments=m=>localStorage.setItem(LS_COMMENTS_KEY, JSON.stringify(m));

    function CommentList({ row, db, lang }) {
      const list = db[modelKey(row)] || [];
      if (!list.length) return <div className="text-xs text-gray-400">{lang==="zh"?"æš‚æ— è¯„è®º":"No comments yet"}</div>;
      return (
        <div className="max-h-48 overflow-auto border rounded-xl p-2">
          {list.sort((a,b)=>b.ts-a.ts).map(c=>(
            <div key={c.id} className="text-sm py-1">
              <div className="flex items-center gap-2">
                <span className="font-medium">{c.author || (lang==="zh"?"åŒ¿å":"Anonymous")}</span>
                <span className="text-yellow-600">{"â˜…".repeat(Math.max(1, Math.min(5, c.rating || 1)))}</span>
                <span className="text-gray-400 text-xs">{new Date(c.ts).toLocaleString()}</span>
              </div>
              <div className="text-gray-700 whitespace-pre-wrap">{c.text}</div>
            </div>
          ))}
        </div>
      );
    }

    function App() {
      const [lang,setLang]=useState("zh"); const T=I18N[lang];
      const [view,setView]=useState("all"); const [unit,setUnit]=useState("per1k");
      const [srcCurrency,setSrcCurrency]=useState("CNY"); const [displayCurrency,setDisplayCurrency]=useState("CNY"); const [fx,setFx]=useState(7.2);
      const [providerFilter,setProviderFilter]=useState(""); const [search,setSearch]=useState("");
      const [rows,setRows]=useState([]); const [providers,setProviders]=useState([]);
      const [favorites,setFavorites]=useState(()=>{ try{return JSON.parse(localStorage.getItem(LS_FAV_KEY)||"{}");}catch{return{};}});
      useEffect(()=>{ localStorage.setItem(LS_FAV_KEY, JSON.stringify(favorites)); },[favorites]);

      const onUploadChange=e=>{
        const f=e.target.files?.[0]; if(!f) return;
        const reader=new FileReader();
        reader.onload=evt=>{
          const data=new Uint8Array(evt.target.result);
          const wb=XLSX.read(data,{type:"array"});
          const sheet=wb.Sheets[wb.SheetNames[0]];
          const json=XLSX.utils.sheet_to_json(sheet,{defval:null});
          setRows(json);
          const ps=Array.from(new Set(json.map(r=>(r.å‚å•†||"").toString().trim()).filter(Boolean)));
          setProviders(ps);
          document.getElementById('boot-msg')?.remove();
        };
        reader.readAsArrayBuffer(f);
      };
      const loadDemo=()=>{
        const demo=[
          { å‚å•†:"OpenAI", æ¨¡å‹åç§°:"gpt-4o-mini", ç§’æ‡‚è¾“å…¥ä»·æ ¼:2.0, ç§’æ‡‚è¾“å‡ºä»·æ ¼:8.0, å®˜æ–¹è¾“å…¥ä»·æ ¼:3.0, å®˜æ–¹è¾“å‡ºä»·æ ¼:12.0, è®¡è´¹è§„åˆ™:"æŒ‰1k tokens", æ¨¡å‹è¯´æ˜:"è½»é‡å¤šæ¨¡æ€", æ¨¡å‹åœ°åŒº:"us-east", æ˜¯å¦å¸¸ç”¨æ¨¡å‹:"æ˜¯", æ˜¯å¦æ”¶è—:"å¦" },
          { å‚å•†:"Anthropic", æ¨¡å‹åç§°:"Claude 3.5 Sonnet", ç§’æ‡‚è¾“å…¥ä»·æ ¼:5.0, ç§’æ‡‚è¾“å‡ºä»·æ ¼:15.0, å®˜æ–¹è¾“å…¥ä»·æ ¼:5.0, å®˜æ–¹è¾“å‡ºä»·æ ¼:15.0, è®¡è´¹è§„åˆ™:"æŒ‰1k tokens", æ¨¡å‹è¯´æ˜:"é«˜æ€§èƒ½é€šç”¨", æ¨¡å‹åœ°åŒº:"us-west", æ˜¯å¦å¸¸ç”¨æ¨¡å‹:"æ˜¯", æ˜¯å¦æ”¶è—:"æ˜¯" },
        ];
        setRows(demo); setProviders(Array.from(new Set(demo.map(r=>r.å‚å•†))));
        document.getElementById('boot-msg')?.remove();
      };

      const [commentFor,setCommentFor]=useState(null);
      const [nickname,setNickname]=useState(""); const [rating,setRating]=useState(5); const [commentText,setCommentText]=useState("");
      const [commentDb,setCommentDb]=useState(()=>loadAllComments());
      const openComment=r=>{ setCommentFor(r); setRating(5); setCommentText(""); };
      const submitComment=()=>{ if(!commentFor||!commentText.trim())return;
        const key=modelKey(commentFor); const all={...commentDb}; const list=all[key]?[...all[key]]:[];
        list.push({ id:`${Date.now()}`, author:nickname.trim()||undefined, rating:Number(rating)||5, text:commentText.trim(), ts:Date.now() });
        all[key]=list; setCommentDb(all); saveAllComments(all); setCommentFor(null);
      };
      const getAvgRating=r=>{ const list=commentDb[modelKey(r)]||[]; if(!list.length)return null; const s=list.reduce((a,b)=>a+(b.rating||0),0); return s/list.length; };

      const displayRows=useMemo(()=>{
        const mapped=rows.map(r=>{
          const tokenBased=isTokenBasedRule(r.è®¡è´¹è§„åˆ™||undefined);
          const mdIn=parseNumber(r.ç§’æ‡‚è¾“å…¥ä»·æ ¼), mdOut=parseNumber(r.ç§’æ‡‚è¾“å‡ºä»·æ ¼),
                ofIn=parseNumber(r.å®˜æ–¹è¾“å…¥ä»·æ ¼), ofOut=parseNumber(r.å®˜æ–¹è¾“å‡ºä»·æ ¼);
          const _mdIn=tokenBased?convertUnit(mdIn,unit):mdIn;
          const _mdOut=tokenBased?convertUnit(mdOut,unit):mdOut;
          const _ofIn=tokenBased?convertUnit(ofIn,unit):ofIn;
          const _ofOut=tokenBased?convertUnit(ofOut,unit):ofOut;
          const mdInDisp=convertCurrency(_mdIn,srcCurrency,displayCurrency,fx);
          const mdOutDisp=convertCurrency(_mdOut,srcCurrency,displayCurrency,fx);
          const ofInDisp=convertCurrency(_ofIn,srcCurrency,displayCurrency,fx);
          const ofOutDisp=convertCurrency(_ofOut,srcCurrency,displayCurrency,fx);
          const avgR=getAvgRating(r);
          return {
            å‚å•†:(r.å‚å•†||"").toString(),
            æ¨¡å‹åç§°:(r.æ¨¡å‹åç§°||"").toString(),
            è®¡è´¹è§„åˆ™:r.è®¡è´¹è§„åˆ™||"",
            ç§’æ‡‚è¾“å…¥ä»·æ ¼:formatMoney(mdInDisp,displayCurrency),
            ç§’æ‡‚è¾“å‡ºä»·æ ¼:formatMoney(mdOutDisp,displayCurrency),
            å®˜æ–¹è¾“å…¥ä»·æ ¼:formatMoney(ofInDisp,displayCurrency),
            å®˜æ–¹è¾“å‡ºä»·æ ¼:formatMoney(ofOutDisp,displayCurrency),
            å¹³å‡è¯„åˆ†:(avgR===null?"-":avgR.toFixed(2)),
            _raw:r,
          };
        });
        let filtered = mapped.filter(d=>{
          if (view==="fav") return (favorites[modelKey(d._raw)] || isTruthy(d._raw.æ˜¯å¦æ”¶è—));
          if (view==="common") return isTruthy(d._raw.æ˜¯å¦å¸¸ç”¨æ¨¡å‹);
          return true;
        });
        if (providerFilter) filtered = filtered.filter(d=>d.å‚å•†===providerFilter);
        if (search.trim()) {
          const kw=search.trim().toLowerCase();
          filtered = filtered.filter(d=>{
            const n1=d.æ¨¡å‹åç§°.toLowerCase(), n2=(d._raw.æ¨¡å‹è¯´æ˜||"").toLowerCase();
            return n1.includes(kw) || n2.includes(kw);
          });
        }
        filtered.sort((a,b)=>{
          const num = s => { const x = (s||"").toString().replace(/[Â¥$]/g,""); const n = parseFloat(x); return isFinite(n)?n:null; };
          const aNum=num(a.å®˜æ–¹è¾“å…¥ä»·æ ¼), bNum=num(b.å®˜æ–¹è¾“å…¥ä»·æ ¼);
          const _a=aNum==null?Infinity:aNum, _b=bNum==null?Infinity:bNum;
          return _a-_b;
        });
        return filtered;
      }, [rows, unit, srcCurrency, displayCurrency, fx, view, providerFilter, search, favorites, commentDb]);

      const headers = [I18N[lang].table_provider,I18N[lang].table_name,I18N[lang].table_rule,I18N[lang].table_miaodong_in,I18N[lang].table_miaodong_out,I18N[lang].table_official_in,I18N[lang].table_official_out,I18N[lang].avgRating];

      return (
        <div className="min-h-screen">
          <header className="sticky top-0 z-10 bg-white/80 backdrop-blur border-b border-gray-200">
            <div className="max-w-6xl mx-auto px-4 py-3 flex flex-col gap-2 md:flex-row md:items-center md:justify-between">
              <h1 className="text-xl md:text-2xl font-semibold">{T.title}</h1>
              <div className="flex flex-wrap items-center gap-2">
                <input type="file" accept=".xlsx,.xls" onChange={onUploadChange}
                  className="block text-sm text-gray-600 file:mr-3 file:py-2 file:px-3 file:rounded-xl file:border-0 file:bg-gray-900 file:text-white hover:file:bg-gray-800 file:cursor-pointer"
                  aria-label={T.upload} title={T.upload}/>
                <span className="text-gray-400 text-sm select-none">{T.or}</span>
                <button onClick={loadDemo} className="px-3 py-2 rounded-xl text-sm bg-gray-100 hover:bg-gray-200 border border-gray-200">{T.loadDemo}</button>
                <button onClick={()=>exportCsv(displayRows, headers)}
                  className="px-3 py-2 rounded-xl text-sm bg-white hover:bg-gray-50 border border-gray-200">{T.exportCsv}</button>
              </div>
            </div>
          </header>

          <section className="max-w-6xl mx-auto px-4 py-4 grid grid-cols-1 md:grid-cols-12 gap-3">
            <div className="md:col-span-3 bg-white rounded-2xl shadow-sm border p-3">
              <div className="text-sm text-gray-500 mb-2">{T.view}</div>
              <div className="flex gap-2">
                <button onClick={()=>setView("all")} className={`px-3 py-2 rounded-xl text-sm border ${view==="all"?"bg-gray-900 text-white":"bg-white hover:bg-gray-50"}`}>{T.view_all}</button>
                <button onClick={()=>setView("fav")} className={`px-3 py-2 rounded-xl text-sm border ${view==="fav"?"bg-gray-900 text-white":"bg-white hover:bg-gray-50"}`}>{T.view_fav}</button>
                <button onClick={()=>setView("common")} className={`px-3 py-2 rounded-xl text-sm border ${view==="common"?"bg-gray-900 text-white":"bg-white hover:bg-gray-50"}`}>{T.view_common}</button>
              </div>
            </div>

            <div className="md:col-span-4 bg-white rounded-2xl shadow-sm border p-3">
              <div className="grid grid-cols-2 gap-3">
                <div>
                  <div className="text-sm text-gray-500 mb-2">{T.unit}</div>
                  <div className="flex gap-2">
                    <button onClick={()=>setUnit("per1k")} className={`px-3 py-2 rounded-xl text-sm border ${unit==="per1k"?"bg-gray-900 text-white":"bg-white hover:bg-gray-50"}`}>{T.per1k}</button>
                    <button onClick={()=>setUnit("per1m")} className={`px-3 py-2 rounded-xl text-sm border ${unit==="per1m"?"bg-gray-900 text-white":"bg-white hover:bg-gray-50"}`}>{T.per1m}</button>
                  </div>
                </div>
                <div>
                  <div className="text-sm text-gray-500 mb-2">{T.language}</div>
                  <div className="flex gap-2">
                    <button onClick={()=>setLang("zh")} className={`px-3 py-2 rounded-xl text-sm border ${lang==="zh"?"bg-gray-900 text-white":"bg-white hover:bg-gray-50"}`}>ä¸­æ–‡</button>
                    <button onClick={()=>setLang("en")} className={`px-3 py-2 rounded-xl text-sm border ${lang==="en"?"bg-gray-900 text-white":"bg-white hover:bg-gray-50"}`}>EN</button>
                  </div>
                </div>
              </div>
            </div>

            <div className="md:col-span-5 bg-white rounded-2xl shadow-sm border p-3">
              <div className="grid md:grid-cols-3 grid-cols-1 gap-3">
                <div>
                  <div className="text-sm text-gray-500 mb-1">{T.srcCurrency}</div>
                  <select value={srcCurrency} onChange={e=>setSrcCurrency(e.target.value)} className="w-full border rounded-xl px-3 py-2">
                    <option value="CNY">CNY</option><option value="USD">USD</option>
                  </select>
                </div>
                <div>
                  <div className="text-sm text-gray-500 mb-1">{T.displayCurrency}</div>
                  <select value={displayCurrency} onChange={e=>setDisplayCurrency(e.target.value)} className="w-full border rounded-xl px-3 py-2">
                    <option value="CNY">CNY</option><option value="USD">USD</option>
                  </select>
                </div>
                <div>
                  <div className="text-sm text-gray-500 mb-1">{T.fxRate}</div>
                  <input type="number" step="0.0001" value={fx} onChange={e=>setFx(Number(e.target.value))} className="w-full border rounded-xl px-3 py-2"/>
                </div>
              </div>
            </div>

            <div className="md:col-span-3 bg-white rounded-2xl shadow-sm border p-3">
              <div className="text-sm text-gray-500 mb-2">{T.provider}</div>
              <select value={providerFilter} onChange={e=>setProviderFilter(e.target.value)} className="w-full border rounded-xl px-3 py-2">
                <option value="">{I18N[lang].none}</option>
                {/* åŠ¨æ€å‚å•†åˆ—è¡¨ */}
                {providers.map(p=> <option key={p} value={p}>{p}</option>)}
              </select>
            </div>
            <div className="md:col-span-9 bg-white rounded-2xl shadow-sm border p-3">
              <div className="text-sm text-gray-500 mb-2">{T.search}</div>
              <input value={search} onChange={e=>setSearch(e.target.value)} placeholder="gpt / sonnet / llamaâ€¦" className="w-full border rounded-xl px-3 py-2" />
            </div>
          </section>

          <main className="max-w-6xl mx-auto px-4 pb-12">
            <p className="text-xs text-gray-500 mb-2">{T.priceNote}</p>
            <div className="overflow-auto rounded-2xl border bg-white shadow-sm">
              <table className="min-w-full text-sm">
                <thead className="bg-gray-50">
                  <tr>
                    <th className="text-left px-4 py-3 w-28">{T.table_provider}</th>
                    <th className="text-left px-4 py-3 w-56">{T.table_name}</th>
                    <th className="text-left px-4 py-3 w-40">{T.table_rule}</th>
                    <th className="text-left px-4 py-3">{T.table_miaodong_in}</th>
                    <th className="text-left px-4 py-3">{T.table_miaodong_out}</th>
                    <th className="text-left px-4 py-3">{T.table_official_in}</th>
                    <th className="text-left px-4 py-3">{T.table_official_out}</th>
                    <th className="text-left px-4 py-3 w-24">{T.avgRating}</th>
                    <th className="text-left px-4 py-3 w-36">{I18N[lang].table_ops}</th>
                  </tr>
                </thead>
                <tbody>
                  {/* å†…å®¹æ¸²æŸ“ */}
                  {displayRows.length===0 ? (
                    <tr><td colSpan="9" className="text-center text-gray-400 py-12">{T.noData}</td></tr>
                  ) : displayRows.map(r=>{
                    const key=modelKey(r._raw);
                    const isFav=(favorites[key] || isTruthy(r._raw.æ˜¯å¦æ”¶è—));
                    return (
                      <tr key={key} className="border-t hover:bg-gray-50">
                        <td className="px-4 py-3 align-top">{r.å‚å•†}</td>
                        <td className="px-4 py-3 align-top">
                          <div className="font-medium">{r.æ¨¡å‹åç§°}</div>
                          {r._raw.æ¨¡å‹è¯´æ˜ ? (<div className="text-gray-500 text-xs mt-1 two-lines">{r._raw.æ¨¡å‹è¯´æ˜}</div>) : null}
                          {r._raw.æ¨¡å‹åœ°åŒº ? (<div className="text-gray-400 text-xs mt-1">{r._raw.æ¨¡å‹åœ°åŒº}</div>) : null}
                        </td>
                        <td className="px-4 py-3 align-top">{r.è®¡è´¹è§„åˆ™ || "-"}</td>
                        <td className="px-4 py-3 align-top">{r.ç§’æ‡‚è¾“å…¥ä»·æ ¼}</td>
                        <td className="px-4 py-3 align-top">{r.ç§’æ‡‚è¾“å‡ºä»·æ ¼}</td>
                        <td className="px-4 py-3 align-top">{r.å®˜æ–¹è¾“å…¥ä»·æ ¼}</td>
                        <td className="px-4 py-3 align-top">{r.å®˜æ–¹è¾“å‡ºä»·æ ¼}</td>
                        <td className="px-4 py-3 align-top">{r.å¹³å‡è¯„åˆ†}</td>
                        <td className="px-4 py-3 align-top">
                          <div className="flex gap-2">
                            <button onClick={()=>setFavorites(m=>({...m,[key]:!isFav}))}
                              className={`px-2 py-1 rounded-lg border text-xs ${isFav?"bg-yellow-100 border-yellow-300":"bg-white hover:bg-gray-50"}`}
                              title={isFav ? T.unfav : T.fav}>
                              {isFav ? "â˜…" : "â˜†"} {isFav ? T.unfav : T.fav}
                            </button>
                            <button onClick={()=>openComment(r._raw)}
                              className="px-2 py-1 rounded-lg border text-xs bg-white hover:bg-gray-50">ğŸ’¬ {T.comment}</button>
                          </div>
                        </td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>
          </main>

          {/* è¯„è®ºå¼¹çª— */}
          {commentFor && (
            <div className="fixed inset-0 z-20 flex items-center justify-center bg-black/30 px-4" onClick={()=>setCommentFor(null)}>
              <div className="bg-white rounded-2xl shadow-xl w-full max-w-lg" onClick={e=>e.stopPropagation()}>
                <div className="p-4 border-b flex items-center justify-between">
                  <div className="text-base font-semibold">{T.addComment} Â· {commentFor.å‚å•†} / {commentFor.æ¨¡å‹åç§°}</div>
                  <button className="text-gray-500 hover:text-gray-700" onClick={()=>setCommentFor(null)}>{T.close}</button>
                </div>
                <div className="p-4 space-y-3">
                  <div>
                    <div className="text-sm text-gray-500 mb-1">{T.nickname}</div>
                    <input value={nickname} onChange={e=>setNickname(e.target.value)} className="w-full border rounded-xl px-3 py-2" />
                  </div>
                  <div>
                    <div className="text-sm text-gray-500 mb-1">{T.rating}</div>
                    <input type="number" min="1" max="5" value={rating} onChange={e=>setRating(e.target.value)} className="w-full border rounded-xl px-3 py-2" />
                  </div>
                  <div>
                    <div className="text-sm text-gray-500 mb-1">{T.content}</div>
                    <textarea value={commentText} onChange={e=>setCommentText(e.target.value)} className="w-full border rounded-xl px-3 py-2 min-h-[120px]" />
                  </div>
                  <CommentList row={commentFor} db={commentDb} lang={lang} />
                </div>
                <div className="p-4 border-t flex justify-end gap-2">
                  <button onClick={()=>setCommentFor(null)} className="px-3 py-2 rounded-xl text-sm bg-white hover:bg-gray-50 border">{T.cancel}</button>
                  <button onClick={submitComment} className="px-3 py-2 rounded-xl text-sm bg-gray-900 text-white hover:bg-gray-800">{T.submit}</button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
